<?php
/**
 * condition.php
 */
namespace X\Database\SQL\Condition;
/**
 * Condition
 * 
 * @author  Michael Luthor <michael.the.ranidae@gmail.com>
 * @since   0.0.0
 * @version 0.0.0
 */
class Condition extends \X\Database\Base {
    /**
     * The operator mark of equal
     * 
     * @var integer
     */
    const OPERATOR_EQUAL            = 0;
    
    /**
     * The operator mark of "not equal"
     *
     * @var integer
     */
    const OPERATOR_NOT_EQUAL        = 1;
    
    /**
     * The operator mark of "greater than"
     *
     * @var integer
     */
    const OPERATOR_GREATER_THAN     = 2;
    
    /**
     * The operator mark of "greater or equal"
     *
     * @var integer
     */
    const OPERATOR_GREATER_OR_EQUAL = 3;
    
    /**
     * The operator mark of "less than"
     *
     * @var integer
     */
    const OPERATOR_LESS_THAN        = 4;
    
    /**
     * The operator mark of "less or equal"
     *
     * @var integer
     */
    const OPERATOR_LESS_OR_EQUAL    = 5;

    /**
     * The operator mark of "like"
     *
     * @var integer
     */
    const OPERATOR_LIKE             = 6;

    /**
     * The operator mark of "start with"
     *
     * @var integer
     */
    const OPERATOR_START_WITH       = 7;

    /**
     * The operator mark of "end with"
     *
     * @var integer
     */
    const OPERATOR_END_WITH         = 8;

    /**
     * The operator mark of "between"
     *
     * @var integer
     */
    const OPERATOR_BETWEEN          = 9;

    /**
     * The operator mark of "in"
     *
     * @var integer
     */
    const OPERATOR_IN               = 10;

    /**
     * The operator mark of "not in"
     *
     * @var integer
     */
    const OPERATOR_NOT_IN           = 11;
    
    /**
     * This value contains all supported operators.
     * 
     * @var array
     */
    protected static $operators = array(
        '=', '<>', '>', '>=', '<', '<=', 'Like', 'StartWith', 
        'EndWith', 'Between', 'In', 'NotIn');
    
    /**
     * The column name that current condition object effected.
     * 
     * @var string
     */
    protected $column = null;
    
    /**
     * The operator of current condition object.
     * 
     * @var integer
     */
    protected $operator = null;
    
    /**
     * The value that current condition column would handle.
     * 
     * @var mixed
     */
    protected $value = null;
    
    /**
     * Initiate the condition object by given informations
     * 
     * @param string $column The name of column
     * @param string $operator The operator of current condition
     * @param string $value The value for column to handle
     * @return void
     */
    public function __construct( $column, $operator, $value ) {
        $this->column = $column;
        $this->operator = $operator;
        $this->value = $value;
    }
    
    /**
     * Convert current condition object to string.
     * 
     * @return string
     */
    public function toString() {
        $handler = sprintf('stringBuilder%s', self::$operators[$this->operator]);
        if ( method_exists($this, $handler) ) {
            return $this->$handler();
        }
        else {
            return $this->defaultStringBuilder();
        }
    }
    
    /**
     * The default string build for curent condition object.
     * 
     * @return string
     */
    protected function defaultStringBuilder() {
        $column = sprintf('`%s`', $this->column);
        $value  = \X\Database\Management::getManager()->getDb()->quote($this->value);
        return sprintf('%s %s %s', $column, self::$operators[$this->operator], $value);
    }
    
    /**
     * Build condition string for operator "like" 
     * 
     * @return string
     */
    protected function stringBuilderLike() {
        $column = sprintf('`%s`', $this->column);
        $value  = \X\Database\Management::getManager()->getDb()->quote($this->value);
        return sprintf('%s LIKE %s', $column, $value);
    }
    
    /**
     * Build condition string for operator "start with"
     * 
     * @return string
     */
    protected function stringBuilderStartWith() {
        $column = sprintf('`%s`', $this->column);
        $value  = sprintf('%s', \X\Database\Management::getManager()->getDb()->quote($this->value.'%%'));
        return sprintf('%s LIKE %s', $column, $value);
    }
    
    /**
     * Build condition string for operator "end with"
     * 
     * @return string
     */
    protected function stringBuilderEndWith() {
        $column = sprintf('`%s`', $this->column);
        $value  = sprintf('%s', \X\Database\Management::getManager()->getDb()->quote('%%'.$this->value));
        return sprintf('%s LIKE %s', $column, $value);
    }
    
    /**
     * Build condition string for operator "between"
     * 
     * @return string
     */
    protected function stringBuilderBetween() {
        $column = sprintf('`%s`', $this->column);
        $minVal = \X\Database\Management::getManager()->getDb()->quote($this->value[0]);
        $maxVal = \X\Database\Management::getManager()->getDb()->quote($this->value[1]);
        return sprintf('%s BETWEEN (%s, %s)', $column, $minVal, $maxVal);
    }
    
    /**
     * Build condition string for operator "in"
     * 
     * @return string
     */
    protected function stringBuilderIn() {
        $column = sprintf('`%s`', $this->column);
        $values = array();
        foreach ( $this->value as $value ) {
            $values[] = \X\Database\Management::getManager()->getDb()->quote($value);
        }
        return sprintf('%s IN (%s)', $column, implode(',', $values));
    }
    
    /**
     * Build condition string for operator "not in"
     *
     * @return string
     */
    protected function stringBuilderNotIn() {
        $column = sprintf('`%s`', $this->column);
        $values = array();
        foreach ( $this->value as $value ) {
            $values[] = \X\Database\Management::getManager()->getDb()->quote($value);
        }
        return sprintf('%s NOT IN (%s)', $column, implode(',', $values));
    }
}
