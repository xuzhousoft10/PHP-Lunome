<?php
/**
 * management.php
 */
namespace X\Database;
/**
 * Management
 *
 * @author  Michael Luthor <michael.the.ranidae@gmail.com>
 * @since   0.0.0
 * @version 0.0.0
 */
class Management extends \X\Database\Base {
    /**
     * The mmanagement object 
     * 
     * @var Management
     */
    protected static $manager = null;
    
    /**
     * Get manager from management 
     * 
     * @return Management
     */
    public static function getManager() {
        return self::$manager = is_null(self::$manager) ? new Management() :self::$manager;
    }
    
    /**
     * Initiate the management object
     * 
     * @return void
     */
    protected function __construct() {
        $this->autoloadList = require dirname(__FILE__).DIRECTORY_SEPARATOR.'autolist.php';
        spl_autoload_register(array($this, 'autoloader'));
    }
    
    /**
     * This value contains the class map for xdb.
     * <pre>
     *      -- key      : The class name
     *      -- value    : The path of class
     * </pre>
     * @var string[]
     */
    protected $autoloadList = array();
    
    /**
     * The autoloader of xdb.
     * 
     * @param string $class -- The name of class needs to load.
     */
    protected function autoloader( $class ) {
        if ( !isset($this->autoloadList[$class]) ) return false;
        require dirname(dirname(__FILE__)).DIRECTORY_SEPARATOR.$this->autoloadList[$class];
        unset($this->autoloadList[$class]);
        if ( 0 == count($this->autoloadList) ) {
            spl_autoload_unregister(array($this, 'autoloader'));
        }
    }
    
    /**
     * This value contains all the database object that manager is using.
     * 
     * @var Database[]
     */
    protected $dbs = array();
    
    /**
     * Add db to manager with configurations. If the name already exists,
     * then an error will be throwed.
     * 
     * @param string $name The name of db for db in manager.
     * @param array  $config The configurations for that db.
     * @return void
     */
    public function addDb( $name, $config ) {
        if ( isset($this->dbs[$name]) ) {
            throw new \X\Database\Exception(sprintf('Db "%s" already exists in db manager.', $name));
        }
        $this->dbs[$name] = new Database($config);
    }
    
    /**
     * Get db from manager by given name, if the db does not exists,
     * an error will be throwed.
     * 
     * @param string $name The name of db you need.
     * @return Database
     */
    public function getDb( $name=null ) {
        if ( is_null($name) ) {
            $name = $this->current;
        }
        
        $this->checkDbByName($name);
        return $this->dbs[$name];
    }
    
    /**
     * Check whether the db exists by given name. 
     * Return true if exists or false if not.
     * 
     * @param string $name The name of db to check
     * @return boolean
     */
    public function hasDb( $name=self::DEFAULT_DB_NAME ) {
        return isset($this->dbs[$name]);
    }
    
    /**
     * Default using name of db.
     * 
     * @var string
     */
    const DEFAULT_DB_NAME = 'default';
    
    /**
     * The name of using db name, As default, the db which named 
     * 'default' will be setted as using.
     * 
     * @var string The name of current db.
     */
    protected $current = self::DEFAULT_DB_NAME;
    
    /**
     * Switch current db by given name.
     * If database does not exists, an exception will be throwed.
     * 
     * @param string $name The name of db that would be switch to.
     * @return void
     */
    public function switchTo( $name ) {
        $this->checkDbByName($name);
        $this->current = $name;
    }
    
    /**
     * Get the name of using db.
     * 
     * @return string
     */
    public function getCurrentDbName() {
        return $this->current;
    }
    
    /**
     * Remove database from db manager, if you are removing using
     * db, then the default db will be used as current database.
     * If database does not exists, an exception will be throwed.
     * 
     * @param string $name -- The name of db in manager will be deleted
     * @return null
     */
    public function removeDb( $name ) {
        $this->checkDbByName($name);
        unset($this->dbs[$name]);
        if ( $name === $this->current ) {
            $this->current = self::DEFAULT_DB_NAME;
        }
    }
    
    /**
     * Check whether the db exists by given name.
     * 
     * @param string $name -- The name of db in manager will be checked.
     * @throws \X\Database\Exception -- When given name does not exists.
     */
    protected function checkDbByName( $name ) {
        if ( !isset($this->dbs[$name]) ) {
            throw new \X\Database\Exception(sprintf('Can not find "%s" in DB manager.', $name));
        }
    }
}
